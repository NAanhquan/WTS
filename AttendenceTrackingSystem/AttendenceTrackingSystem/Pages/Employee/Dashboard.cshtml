@page
@model AttendanceTrackingSystem.Pages.Employee.DashboardModel
@{
    ViewData["Title"] = "Dashboard Nhân viên";
}

<!-- Message Alert -->
@if (!string.IsNullOrEmpty(Model.Message))
{
    <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
        <i class="bi @(Model.IsSuccess ? "bi-check-circle" : "bi-exclamation-circle") me-2"></i>
        @Model.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Today's Attendance Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm border-0">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title mb-1">
                            <i class="bi bi-calendar-day text-primary me-2"></i>
                            Chấm công hôm nay
                        </h5>
                        <p class="text-muted mb-0">@DateTime.Today.ToString("dddd, dd/MM/yyyy")</p>

                        <div class="mt-3">
                            <span class="badge @Model.TodayStatus.StatusBadgeClass fs-6 me-3">
                                @Model.TodayStatus.StatusMessage
                            </span>

                            @if (Model.TodayStatus.CurrentWorkingTime.HasValue)
                            {
                                <span class="text-info">
                                    <i class="bi bi-clock me-1"></i>
                                    Đang làm việc: @Model.TodayStatus.CurrentWorkingTime.Value.Hours:@Model.TodayStatus.CurrentWorkingTime.Value.Minutes.ToString("00")
                                </span>
                            }
                        </div>

                        @if (Model.TodayAttendance != null)
                        {
                            <div class="mt-3">
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="border-end">
                                            <h6 class="text-success mb-1">Vào</h6>
                                            <span class="h5">@Model.TodayAttendance.CheckInDisplay</span>
                                            @if (Model.TodayAttendance.IsLateCheckIn)
                                            {
                                                <small class="d-block text-warning">
                                                    <i class="bi bi-exclamation-triangle"></i> Muộn
                                                </small>
                                            }
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <h6 class="text-danger mb-1">Ra</h6>
                                        <span class="h5">@Model.TodayAttendance.CheckOutDisplay</span>
                                        @if (Model.TodayAttendance.IsEarlyCheckOut)
                                        {
                                            <small class="d-block text-warning">
                                                <i class="bi bi-exclamation-triangle"></i> Sớm
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Check-in/Check-out Buttons -->
                    <div class="col-md-6 text-center">
                        <div class="attendance-clock mb-3">
                            <div class="clock-display">
                                <div id="currentTime" class="display-4 fw-bold text-primary"></div>
                                <div class="text-muted">@DateTime.Now.ToString("dd/MM/yyyy")</div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-block">
                            @if (Model.TodayStatus.CanCheckIn)
                            {
                                <form method="post" asp-page-handler="CheckIn" class="d-inline">
                                    <input type="hidden" asp-for="CheckInInput.CheckInTime" />
                                    <button type="submit" class="btn btn-success btn-lg px-4" onclick="setCurrentTime('CheckInInput.CheckInTime')">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>
                                        Chấm công vào
                                    </button>
                                </form>
                            }

                            @if (Model.TodayStatus.CanCheckOut)
                            {
                                <form method="post" asp-page-handler="CheckOut" class="d-inline">
                                    <input type="hidden" asp-for="CheckOutInput.AttendanceId" value="@Model.TodayStatus.AttendanceId" />
                                    <input type="hidden" asp-for="CheckOutInput.CheckOutTime" />
                                    <button type="submit" class="btn btn-danger btn-lg px-4" onclick="setCurrentTime('CheckOutInput.CheckOutTime')">
                                        <i class="bi bi-box-arrow-right me-2"></i>
                                        Chấm công ra
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Statistics -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-calendar-check text-primary fs-1"></i>
                <h4 class="mt-2">@Model.WeeklyReport.TotalPresentDays</h4>
                <p class="text-muted mb-0">Ngày làm việc</p>
                <small class="text-muted">Tuần này</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-clock text-success fs-1"></i>
                <h4 class="mt-2">@Model.WeeklyReport.TotalWorkingHours.Hours:@Model.WeeklyReport.TotalWorkingHours.Minutes.ToString("00")</h4>
                <p class="text-muted mb-0">Tổng giờ làm</p>
                <small class="text-muted">Trung bình: @Model.WeeklyReport.AverageWorkingHours.ToString("F1")h</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-exclamation-triangle text-warning fs-1"></i>
                <h4 class="mt-2">@Model.WeeklyReport.LateCheckIns</h4>
                <p class="text-muted mb-0">Lần đi muộn</p>
                <small class="text-muted">Tuần này</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-award text-info fs-1"></i>
                <h4 class="mt-2">@Model.WeeklyReport.AttendanceScore.ToString("F0")%</h4>
                <p class="text-muted mb-0">Điểm chấm công</p>
                <small class="text-muted">Tuần này</small>
            </div>
        </div>
    </div>
</div>

<!-- Recent Attendance History -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-clock-history me-2"></i>
                    Lịch sử chấm công gần đây
                </h6>
                <a asp-page="/Employee/Attendance/History" class="btn btn-sm btn-outline-primary">
                    Xem tất cả
                </a>
            </div>
            <div class="card-body p-0">
                @if (Model.RecentAttendance.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Ngày</th>
                                    <th>Giờ vào</th>
                                    <th>Giờ ra</th>
                                    <th>Thời gian làm</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in Model.RecentAttendance)
                                {
                                    <tr>
                                        <td>@record.DateDisplay</td>
                                        <td>
                                            @record.CheckInDisplay
                                            @if (record.IsLateCheckIn)
                                            {
                                                <i class="bi bi-exclamation-triangle text-warning" title="Đi muộn"></i>
                                            }
                                        </td>
                                        <td>
                                            @record.CheckOutDisplay
                                            @if (record.IsEarlyCheckOut)
                                            {
                                                <i class="bi bi-exclamation-triangle text-warning" title="Ra sớm"></i>
                                            }
                                        </td>
                                        <td>
                                            <span class="@(record.IsFullDay ? "text-success" : "text-warning")">
                                                @record.WorkingHoursDisplay
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge @record.StatusBadgeClass">
                                                @record.StatusDisplay
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-x display-4 text-muted mb-3"></i>
                        <p class="text-muted">Chưa có dữ liệu chấm công</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Update current time display
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN');
            document.getElementById('currentTime').textContent = timeString;
        }

        // Set current time to hidden input before form submission
        function setCurrentTime(inputName) {
            const now = new Date();
            const isoString = now.toISOString().slice(0, 19);
            document.querySelector(`input[name="${inputName}"]`).value = isoString;
        }

        // Update time every second
        updateTime();
        setInterval(updateTime, 1000);

        // Auto refresh page every 5 minutes to update working time
        setTimeout(() => {
            if (!document.hidden) {
                location.reload();
            }
        }, 300000); // 5 minutes
    </script>
}
